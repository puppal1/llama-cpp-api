<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLaMA.cpp Web Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/model_manager.js"></script>
</head>
<body class="bg-light">
    <div class="container">
        <nav class="nav-menu">
            <h1>LLaMA.cpp Web Interface</h1>
            <div class="nav-tabs">
                <button class="btn btn-link active" data-tab="chat">Chat</button>
                <button class="btn btn-link" data-tab="monitor">Monitor</button>
                <button class="btn btn-link" data-tab="settings">Settings</button>
            </div>
        </nav>

        <!-- Chat Tab -->
        <div class="tab-content" id="chatTab">
            <div class="row">
                <!-- Model Management -->
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Load Model</h5>
                            <div class="mb-3">
                                <label for="modelPath" class="form-label">Model</label>
                                <select class="form-select" id="modelPath">
                                    <option value="models/mistral-7b-instruct-v0.2.Q4_K_M.gguf" data-id="mistral-7b-instruct-v0">mistral-7b-instruct-v0</option>
                                    <option value="models/Phi-3-mini-4k-instruct-q4.gguf" data-id="Phi-3-mini-4k-instruct-q4">Phi-3-mini-4k-instruct-q4</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modelId" class="form-label">Model ID</label>
                                <input type="text" class="form-control" id="modelId" readonly>
                            </div>
                            <button class="btn btn-primary" onclick="modelManager.loadModel(document.getElementById('modelId').value)">Load Model</button>
                        </div>
                    </div>

                    <div id="modelList" class="model-list"></div>
                </div>

                <!-- Chat Interface -->
                <div class="col-md-8">
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages"></div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                            <button id="sendButton" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                    <small id="activeModel" class="text-muted mt-2">No model loaded</small>
                </div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div class="tab-content hidden" id="monitorTab">
            <div class="metrics-container">
                <!-- CPU Metrics -->
                <div class="metric-card">
                    <h3 class="metric-title">CPU Usage</h3>
                    <div class="progress-bar">
                        <div id="cpuProgress" class="progress-fill cpu" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span id="cpuPercent">0%</span>
                        <span>100%</span>
                    </div>
                    <canvas id="cpuChart" height="100"></canvas>
                </div>

                <!-- Memory Metrics -->
                <div class="metric-card">
                    <h3 class="metric-title">Memory Usage</h3>
                    <div class="progress-bar">
                        <div id="memoryProgress" class="progress-fill memory" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span id="memoryUsed">0 GB</span>
                        <span id="memoryTotal">0 GB</span>
                    </div>
                    <canvas id="memoryChart" height="100"></canvas>
                </div>

                <!-- GPU Metrics -->
                <div id="gpuMetrics" class="metric-card hidden">
                    <h3 class="metric-title">GPU Memory</h3>
                    <div class="progress-bar">
                        <div id="gpuProgress" class="progress-fill gpu" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span id="gpuUsed">0 GB</span>
                        <span id="gpuTotal">0 GB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content hidden" id="settingsTab">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Model Parameters</h5>
                        </div>
                        <div class="card-body">
                            <form id="modelSettingsForm">
                                <!-- Context and Batch Settings -->
                                <div class="settings-section">
                                    <h6>Context and Batch</h6>
                                    <div class="mb-3">
                                        <label for="num_ctx" class="form-label">Context Window Size</label>
                                        <input type="number" class="form-control" id="num_ctx" name="num_ctx" min="0" value="2048">
                                        <small class="text-muted">Size of the context window used to generate the next token</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="num_batch" class="form-label">Batch Size</label>
                                        <input type="number" class="form-control" id="num_batch" name="num_batch" min="0" value="512">
                                        <small class="text-muted">Sets the batch size used by the model</small>
                                    </div>
                                </div>

                                <!-- Temperature Settings -->
                                <div class="settings-section">
                                    <h6>Temperature and Sampling</h6>
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label">Temperature</label>
                                        <input type="range" class="form-range" id="temperature" name="temperature" min="0" max="2" step="0.1" value="0.8">
                                        <small class="text-muted">Higher values = more creative (0.0 - 2.0)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="top_k" class="form-label">Top K</label>
                                        <input type="number" class="form-control" id="top_k" name="top_k" min="0" value="40">
                                        <small class="text-muted">Reduces sampling to the k most likely tokens</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="top_p" class="form-label">Top P</label>
                                        <input type="range" class="form-range" id="top_p" name="top_p" min="0" max="1" step="0.05" value="0.9">
                                        <small class="text-muted">Nucleus sampling threshold (0.0 - 1.0)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Advanced Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="advancedSettingsForm">
                                <!-- Repetition Control -->
                                <div class="settings-section">
                                    <h6>Repetition Control</h6>
                                    <div class="mb-3">
                                        <label for="repeat_penalty" class="form-label">Repeat Penalty</label>
                                        <input type="range" class="form-range" id="repeat_penalty" name="repeat_penalty" min="1.0" max="2.0" step="0.1" value="1.1">
                                        <small class="text-muted">Penalty for repeated tokens</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="repeat_last_n" class="form-label">Repeat Last N</label>
                                        <input type="number" class="form-control" id="repeat_last_n" name="repeat_last_n" min="0" value="64">
                                        <small class="text-muted">Number of tokens to look back for repetitions</small>
                                    </div>
                                </div>

                                <!-- Performance Settings -->
                                <div class="settings-section">
                                    <h6>Performance</h6>
                                    <div class="mb-3">
                                        <label for="num_thread" class="form-label">Number of Threads</label>
                                        <input type="number" class="form-control" id="num_thread" name="num_thread" min="1" value="8">
                                        <small class="text-muted">Number of CPU threads to use</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="mlock" name="mlock">
                                            <label class="form-check-label" for="mlock">Lock Model in Memory</label>
                                        </div>
                                        <small class="text-muted">Prevents the model from being swapped to disk</small>
                                    </div>
                                </div>

                                <!-- Advanced Parameters -->
                                <div class="settings-section">
                                    <h6>Advanced Parameters</h6>
                                    <div class="mb-3">
                                        <label for="seed" class="form-label">Random Seed</label>
                                        <input type="number" class="form-control" id="seed" name="seed" value="-1">
                                        <small class="text-muted">Set to -1 for random seed</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="num_predict" class="form-label">Max Tokens to Generate</label>
                                        <input type="number" class="form-control" id="num_predict" name="num_predict" min="-1" value="256">
                                        <small class="text-muted">Maximum number of tokens to generate (-1 for unlimited)</small>
                                    </div>
                                </div>
                            </form>
                            <button class="btn btn-primary mt-3" onclick="modelManager.saveSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/metrics.js"></script>
    <script src="js/chat.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('[data-tab]').forEach(button => {
            button.addEventListener('click', () => {
                // Update button states
                document.querySelectorAll('[data-tab]').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                // Show selected tab
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                document.getElementById(`${button.dataset.tab}Tab`).classList.remove('hidden');
            });
        });

        // Update model ID when model is selected
        document.getElementById('modelPath').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById('modelId').value = selectedOption.dataset.id;
        });

        // Initialize model ID
        document.getElementById('modelId').value = document.getElementById('modelPath').options[0].dataset.id;
    </script>
</body>
</html>